<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Agent Builder — Quickstart</title>

  <!-- your styles (unchanged) -->
  <style>body{margin:0;font-family:Segoe UI,Roboto,Arial;background:#0b1220;color:#e7ecf3}header{padding:16px 20px;border-bottom:1px solid #1f2942;display:flex;justify-content:space-between}.pill{background:linear-gradient(120deg,#7dd3fc,#a78bfa);padding:6px 10px;border-radius:999px;color:#0a0d17;font-weight:700}.wrap{display:grid;grid-template-columns:380px 1fr;gap:16px;padding:16px;min-height:calc(100vh - 60px)}.card{background:linear-gradient(180deg,#0f1830,#0c1528);border:1px solid #1f2942;border-radius:16px;padding:16px}input,textarea{width:100%;padding:10px 12px;border:1px solid #2a3758;border-radius:10px;background:#0b1326;color:#e7ecf3}textarea{min-height:120px}.btn{cursor:pointer;background:linear-gradient(120deg,#7dd3fc,#a78bfa);border:none;border-radius:10px;padding:10px 12px;color:#0a0d17;font-weight:800}.row{display:flex;gap:8px;align-items:center}.tabs{display:flex;gap:8px;margin:8px 0}.tab{flex:1;text-align:center;padding:10px;border-radius:10px;border:1px solid #1f2942;background:#0d1630;cursor:pointer}.tab.active{background:#111c38}.muted{color:#93a4bd;font-size:12px}.chat{display:flex;flex-direction:column;height:calc(100vh - 108px)}.chatlog{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px}.bubble{padding:12px;border-radius:14px;max-width:70%}.user{align-self:flex-end;background:#0e1a36;border:1px solid #22325a}.bot{align-self:flex-start;background:#0b142b;border:1px solid #203055}.cite{margin-top:8px;font-size:12px;color:#a3b3cf}</style>
  <style>
    .source-form { max-width: 420px; }
    .source-form .field { margin: 12px 0; }
    .source-form input,
    .source-form textarea,
    .source-form button { display:block; width:100%; box-sizing:border-box; }
    .source-form input,
    .source-form textarea {
      padding:10px 12px; border-radius:12px; border:1px solid #2d2f3a;
      background:#0f172a; color:#e5e7eb;
    }
    .source-form textarea { height:130px; resize:vertical; }
    .source-form input:focus, .source-form textarea:focus {
      outline:none; border-color:#6366f1; box-shadow:0 0 0 2px rgba(99,102,241,.35);
    }
    .source-form button {
      margin-top:8px; padding:10px 14px; border:0; border-radius:12px;
      background:linear-gradient(90deg,#3b82f6,#8b5cf6); color:#fff; font-weight:600; cursor:pointer;
    }
  </style>
  <style>
    .chat { display:flex; flex-direction:column; }
    .chatlog {
      flex:1 1 auto; min-height:280px; max-height:calc(100vh - 240px);
      overflow-y:auto; padding:12px; border:1px solid #2d2f3a; border-radius:14px; background:#0b1222;
    }
    .bubble { display:inline-block; padding:10px 12px; margin:8px 0; border-radius:14px; line-height:1.35; max-width:92%; word-wrap:break-word; box-shadow:0 1px 0 rgba(0,0,0,.15);}
    .bubble.user { background:#1f2937; color:#e5e7eb; border-top-right-radius:4px; align-self:flex-end; }
    .bubble.bot  { background:#0f172a; color:#e5e7eb; border-top-left-radius:4px; align-self:flex-start; }
    .bubble .cite { margin-top:6px; font-size:.85rem; color:#93a0b4; }
    .bubble .cite a { color:#93c5fd; text-decoration:none; }
    .bubble .cite a:hover { text-decoration:underline; }
    /* Layout the composer: Persona | Question | Ask */
    .composer{
    margin-top:10px;
    display:grid;
    grid-template-columns: 160px minmax(0,1fr) auto; /* <- minmax(0,1fr) prevents overflow */
    gap:10px;
    align-items:center;
    }

    .composer .persona{
    min-width:160px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #2d2f3a;
    background:#0f172a;
    color:#e5e7eb;
    }

    /* Make sure the text box can actually shrink inside the grid */
    .composer input[type="text"]{
    min-width:0;                  /* <- key line */
    width:100%;
    padding:12px 14px;
    border-radius:12px;
    border:1px solid #2d2f3a;
    background:#0f172a;
    color:#e5e7eb;
    outline:none;
    }
    .composer input[type="text"]:focus{
    border-color:#6366f1;
    box-shadow:0 0 0 2px rgba(99,102,241,.35);
    }

    /* Keep the Ask button a tidy pill and stop wrap/overhang */
    .composer .ask{
    width:80px;                   /* consistent width so edges align */
    text-align:center;
    white-space:nowrap;
    padding:10px 18px;
    border-radius:12px;
    background:linear-gradient(90deg,#3b82f6,#8b5cf6);
    color:#fff; font-weight:600; border:0; cursor:pointer;
    }
    @media (max-width: 640px){
    .composer{
    grid-template-columns: 1fr;  /* stack */
    }
    .composer .ask{ width:100%; }
    }
    @media (max-width: 860px) { .chatlog { max-height: calc(100vh - 320px); } }
    /* --- Fix Ask row layout & make the Ask button flush with the card edge --- */
    .composer {
    margin-top: 10px;
    display: grid;
    /* layout: [persona dropdown] [input grows] [ask button] */
    grid-template-columns: 160px minmax(0, 1fr) max-content;
    gap: 10px;
    align-items: center;
    }

    /* Make sure the persona dropdown isn't squeezed too small */
    .composer select {
    min-width: 120px;
    }

    /* Keep the chat card's standard padding; only pull the button outward */
    .card.chat {
    /* leave your default .card padding alone; no override here */
    }

    /* The actual Ask button (id="ask"): pull it into the card's right padding
     so the button edge aligns with the card border. Your .card padding is 16px. */
    #ask {
    justify-self: end;
    height: 100%;
    margin-right: -16px;     /* matches .card { padding:16px } */
    border-top-right-radius: 12px;
    border-bottom-right-radius: 12px;
    }

    /* Optional: if you use a different card padding on small screens, adjust the pull */
    @media (max-width: 860px) {
    #ask { margin-right: -12px; } /* tweak if your mobile padding is smaller */
    }

  </style>
  <style>
    @keyframes fadeIn { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    .bubble { animation: fadeIn .25s ease both; box-shadow:0 2px 4px rgba(0,0,0,.25); }
    .typing { display:inline-flex; align-items:center; gap:4px; margin:8px 0; padding:8px 14px; border-radius:14px; background:#0f172a; color:#94a3b8; box-shadow:inset 0 0 4px rgba(99,102,241,.25); }
    .typing-dot { width:6px; height:6px; border-radius:50%; background:#6366f1; opacity:.5; animation: blink 1.4s infinite both; }
    .typing-dot:nth-child(2){ animation-delay:.2s }
    .typing-dot:nth-child(3){ animation-delay:.4s }
    @keyframes blink { 0%,80%,100%{opacity:.3; transform:scale(.8)} 40%{opacity:1; transform:scale(1)} }
    body { background: radial-gradient(ellipse at top, #0f172a 0%, #020617 100%); background-attachment: fixed; }
  </style>
  <style>
    .tabs { display:flex; gap:8px; margin:10px 0 14px; }
    .tab { padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none; background:#0f172a; color:#cbd5e1; border:1px solid #1f2937; transition: transform .12s, box-shadow .2s, background .2s; }
    .tab:hover { background:#111827; transform: translateY(-1px); }
    .tab.active { color:#fff; background:#111827; border-color:#334155; box-shadow:0 0 0 2px rgba(99,102,241,.25), 0 10px 25px rgba(99,102,241,.15) inset; position:relative; }
    .tab.active::after { content:""; position:absolute; left:10px; right:10px; bottom:-6px; height:3px; background:linear-gradient(90deg,#3b82f6,#8b5cf6); border-radius:999px; }
    .progress { height:8px; background:#0b1222; border:1px solid #1f2937; border-radius:999px; overflow:hidden; margin-top:10px; }
    .progress .bar { height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#8b5cf6); transition:width .25s; }
    .progress.done .bar { background:linear-gradient(90deg,#22c55e,#16a34a); }
    .sources { margin-top:16px; }
    .source-card { border:1px solid #1f2937; background:#0b1222; border-radius:12px; padding:10px 12px; margin:8px 0; display:flex; align-items:center; gap:10px; }
    .source-pill { font-size:.75rem; padding:2px 8px; border-radius:999px; border:1px solid #334155; color:#93c5fd; background:#0f172a; }
    .source-meta { font-size:.9rem; color:#cbd5e1; }
    .source-meta a { color:#93c5fd; text-decoration:none; }
    .source-meta a:hover { text-decoration:underline; }
  </style>
</head>
<body>
<header>
  <div><b>AI Agent Builder</b></div>
  <div class="pill">Quickstart</div>
</header>

<div class="wrap">
  <section class="card">
    <h3>Add Sources</h3>
    <div class="muted" id="health">Checking API…</div>

    <div class="tabs">
      <div id="t1" class="tab active">Text</div>
      <div id="t2" class="tab">URL</div>
      <div id="t3" class="tab">PDF</div>
    </div>

    <!-- TEXT -->
    <div id="p1" class="source-form">
      <div class="field">
        <label for="title">Title</label>
        <input id="title" type="text" placeholder="Title">
      </div>
      <div class="field">
        <label for="canon">Canonical URL (optional)</label>
        <input id="canon" type="text" placeholder="https://example.com">
      </div>
      <div class="field">
        <label for="txt">Paste text</label>
        <textarea id="txt" placeholder="Paste or type your content here..."></textarea>
      </div>
      <button class="btn" id="ingText">Ingest Text</button>
      <div class="progress" id="pr1" hidden><div class="bar" id="bar1"></div></div>
      <div class="muted" id="s1"></div>
    </div>

    <!-- URL -->
    <div id="p2" class="source-form" style="display:none">
      <div class="field">
        <label for="url">URL</label>
        <input id="url" type="text" placeholder="https://example.com/page">
      </div>
      <button class="btn" id="ingURL">Ingest URL</button>
      <div class="progress" id="pr2" hidden><div class="bar" id="bar2"></div></div>
      <div class="muted" id="s2"></div>
    </div>

    <!-- PDF -->
    <div id="p3" class="source-form" style="display:none">
      <div class="field">
        <label for="pdf">Select PDF</label>
        <input type="file" id="pdf" accept="application/pdf">
      </div>
      <div class="field">
        <label for="pdfTitle">Title (optional)</label>
        <input id="pdfTitle" type="text" placeholder="Document title">
      </div>
      <div class="field">
        <label for="pdfUrl">Canonical URL (optional)</label>
        <input id="pdfUrl" type="text" placeholder="https://example.com/pdf">
      </div>
      <button class="btn" id="ingPDF">Upload PDF</button>
      <div class="progress" id="pr3" hidden><div class="bar" id="bar3"></div></div>
      <div class="muted" id="s3"></div>
    </div>

    <div class="sources">
      <h4 class="muted" style="margin-top:12px">Sources Added</h4>
      <div id="sourcesList"></div>
    </div>
  </section>

  <section class="card chat">
    <h3>Ask</h3>
    <div class="chatlog" id="log"></div>
    <div class="composer">
     <!-- Persona first, consistent placement -->
     <select id="bot" class="persona">
     <option value="">Loading personas…</option>
     </select>

     <!-- Question second -->
     <input id="q" type="text" placeholder="Ask something…">

     <!-- Ask button last -->
     <button class="btn ask" id="ask" type="button">Ask</button>
    </div>
  </section>
</div>

<script>
  /************ CONFIG ************/
  const API_BASE   = window.location.origin;
  const API_KEY    = "564654sdfjshdfkjhg6579687sf465";  // dev/testing only
  const SITE_TOKEN = "";                                  // prod: paste site JWT
  const DEFAULT_BOT_ID = "default";

  const $ = s => document.querySelector(s);

  function authHeaders(json = true) {
    const h = {};
    if (json) h["Content-Type"] = "application/json";
    if (SITE_TOKEN && SITE_TOKEN.length > 10) h["Authorization"] = "Bearer " + SITE_TOKEN;
    else if (API_KEY) h["x-api-key"] = API_KEY;
    return h;
  }

  /************ API helpers ************/
  const apiGet = (path) =>
    fetch(`${API_BASE}${path}`, { method: "GET", headers: authHeaders(false) });

  const apiPost = (path, body) =>
    fetch(`${API_BASE}${path}`, { method: "POST", headers: authHeaders(true), body: JSON.stringify(body) });

  const apiPostForm = (path, formData) =>
    fetch(`${API_BASE}${path}`, { method: "POST", headers: authHeaders(false), body: formData });

  /************ Health ************/
  async function health() {
    try {
      const r = await apiGet("/health/db");
      const j = await r.json();
      $("#health").textContent = j.ok ? "API OK ✅" : "API error ❌";
    } catch {
      $("#health").textContent = "API not reachable ❌";
    }
  }
  health();

  /************ Tabs ************/
  function tab(n){
    ['t1','t2','t3'].forEach((x,i)=>{
      $('#'+x).classList.toggle('active', i===n-1);
      $('#p'+(i+1)).style.display = i===n-1 ? 'block' : 'none';
    });
  }
  $('#t1').onclick=()=>tab(1);
  $('#t2').onclick=()=>tab(2);
  $('#t3').onclick=()=>tab(3);

  /************ Progress helpers ************/
  function setProgress(id, pct, done=false) {
    const wrap = document.getElementById(id);
    if (!wrap) return;
    wrap.hidden = false;
    const bar = wrap.querySelector('.bar');
    bar.style.width = `${pct}%`;
    if (done) wrap.classList.add('done');
  }
  function resetProgress(id){
    const wrap = document.getElementById(id);
    if (!wrap) return;
    wrap.hidden = true; wrap.classList.remove('done');
    wrap.querySelector('.bar').style.width = '0%';
  }
  function pulseProgress(id){
    let pct = 8;
    const tick = () => {
      pct = Math.min(92, pct + Math.random()*8);
      setProgress(id, pct);
      const ref = document.getElementById(id);
      if (ref && !ref.classList.contains('done')) ref._timer = setTimeout(tick, 250);
    };
    tick();
  }
  function stopPulse(id){
    const ref = document.getElementById(id);
    if (ref && ref._timer) { clearTimeout(ref._timer); ref._timer = null; }
  }

  /************ Sources UI helpers ************/
  function addSourceCard({kind, title, url, chunks}) {
    const list = document.getElementById('sourcesList');
    const card = document.createElement('div');
    card.className = 'source-card';
    const pill = document.createElement('span');
    pill.className = 'source-pill';
    pill.textContent = kind.toUpperCase();
    const meta = document.createElement('div');
    meta.className = 'source-meta';
    const safeTitle = title || '(untitled)';
    const link = url ? `<a href="${url}" target="_blank">${safeTitle}</a>` : safeTitle;
    meta.innerHTML = `${link} &nbsp; • &nbsp; ${chunks ?? '?'} chunk${(chunks|0)===1?'':'s'}`;
    card.appendChild(pill); card.appendChild(meta);
    list.prepend(card);
  }

  /************ Personas ************/
  async function loadBots() {
    try {
      const res = await apiGet("/bots");
      const bots = await res.json();
      const sel = document.getElementById("bot");
      sel.innerHTML = "";
      for (const b of bots) {
        const opt = document.createElement("option");
        opt.value = b.id;
        opt.textContent = b.name;
        sel.appendChild(opt);
      }
      sel.value = bots.some(b => b.id === DEFAULT_BOT_ID) ? DEFAULT_BOT_ID : (bots[0]?.id || DEFAULT_BOT_ID);
    } catch {
      const sel = document.getElementById("bot");
      sel.innerHTML = `<option value="${DEFAULT_BOT_ID}">${DEFAULT_BOT_ID}</option>`;
    }
  }
  document.addEventListener("DOMContentLoaded", loadBots);

  /************ Ingest: TEXT ************/
  document.getElementById('ingText').onclick = async () => {
    const title = document.getElementById('title').value.trim();
    const canon = document.getElementById('canon').value.trim();
    const text  = document.getElementById('txt').value.trim();
    const status = document.getElementById('s1');
    resetProgress('pr1'); status.textContent='';
    if (!title || !text) { status.textContent='Please provide a Title and some text.'; return; }
    pulseProgress('pr1');
    try {
      const res = await apiPost('/ingest/text', { title, text, url: canon || null });
      const j = await res.json();
      stopPulse('pr1'); setProgress('pr1', 100, true);
      if (!res.ok) throw new Error(j.detail || 'Ingest failed');
      status.textContent = `Added ${j.chunks} chunk(s).`;
      addSourceCard({ kind:'text', title, url: canon, chunks: j.chunks });
    } catch(e) {
      stopPulse('pr1'); status.textContent = 'Error: ' + e.message;
    } finally {
      setTimeout(()=>resetProgress('pr1'), 900);
    }
  };

  /************ Ingest: URL ************/
  document.getElementById('ingURL').onclick = async () => {
    const url = document.getElementById('url').value.trim();
    const status = document.getElementById('s2');
    resetProgress('pr2'); status.textContent='';
    if (!url) { status.textContent='Please enter a URL.'; return; }
    pulseProgress('pr2');
    try {
      const res = await apiPost('/ingest/url', { url });
      const j = await res.json();
      stopPulse('pr2'); setProgress('pr2', 100, true);
      if (!res.ok) throw new Error(j.detail || 'Ingest failed');
      status.textContent = `Added ${j.chunks} chunk(s).`;
      addSourceCard({ kind:'url', title: j.title || url, url, chunks: j.chunks });
    } catch(e) {
      stopPulse('pr2'); status.textContent = 'Error: ' + e.message;
    } finally {
      setTimeout(()=>resetProgress('pr2'), 900);
    }
  };

  /************ Ingest: PDF ************/
  document.getElementById('ingPDF').onclick = async () => {
    const file = document.getElementById('pdf').files[0];
    const title = document.getElementById('pdfTitle').value.trim();
    const url   = document.getElementById('pdfUrl').value.trim();
    const status = document.getElementById('s3');
    resetProgress('pr3'); status.textContent='';
    if (!file) { status.textContent = 'Please choose a PDF file.'; return; }
    const form = new FormData();
    form.append('file', file);
    if (title) form.append('title', title);
    if (url)   form.append('url', url);
    pulseProgress('pr3');
    try {
      const res = await apiPostForm('/ingest/pdf', form);
      const j = await res.json();
      stopPulse('pr3'); setProgress('pr3', 100, true);
      if (!res.ok) throw new Error(j.detail || 'Upload failed');
      status.textContent = `Added ${j.chunks} chunk(s).`;
      addSourceCard({ kind:'pdf', title: title || file.name, url, chunks: j.chunks });
    } catch(e) {
      stopPulse('pr3'); status.textContent = 'Error: ' + e.message;
    } finally {
      setTimeout(()=>resetProgress('pr3'), 900);
    }
  };

  /************ Chat UI helpers ************/
  function addBubble(text, who){
    const b = document.createElement('div');
    b.className = 'bubble ' + (who==='user'?'user':'bot');
    b.innerHTML = (text || '').replace(/\n/g,'<br/>');
    const log = document.getElementById('log');
    log.appendChild(b);
    log.scrollTop = log.scrollHeight;
    return b;
  }
  function showTyping(){
    const t = document.createElement('div');
    t.className = 'typing'; t.id = 'typing';
    t.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
    const log = document.getElementById('log');
    log.appendChild(t);
    log.scrollTop = log.scrollHeight;
  }
  function hideTyping(){ const t = document.getElementById('typing'); if (t) t.remove(); }

  function currentBotId() {
    const sel = document.getElementById('bot');
    return (sel && sel.value) ? sel.value : DEFAULT_BOT_ID;
  }

  /************ ASK (SSE) ************/
  async function askNow() {
    const qEl = document.getElementById('q');
    const q = qEl.value.trim();
    if (!q) return;

    addBubble(q, 'user');
    qEl.value = '';

    const bot = addBubble('', 'bot');
    showTyping();

    try {
      const resp = await fetch(`${API_BASE}/ask/stream`, {
        method: 'POST',
        headers: authHeaders(true),
        body: JSON.stringify({ question: q, k: 8, bot_id: currentBotId() })
      });

      hideTyping();

      if (!resp.ok || !resp.body) {
        const txt = await resp.text();
        throw new Error(`Request failed: ${resp.status} ${txt}`);
      }

      const reader = resp.body.getReader();
      const dec = new TextDecoder();
      let buf = '';

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buf += dec.decode(value, { stream: true });
        const messages = buf.split('\n\n'); // SSE blocks
        buf = messages.pop();

        for (const msg of messages) {
          let ev = 'message';
          let data = '';
          for (const line of msg.split('\n')) {
            if (line.startsWith('event:')) ev = line.slice(6).trim();
            else if (line.startsWith('data:')) data += line.slice(5);
          }

          if (ev === 'citations') {
            // Render ONLY clickable links
            try {
              const links = JSON.parse(data || '[]');
              if (Array.isArray(links) && links.length) {
                const cite = document.createElement('div');
                cite.className = 'cite';
                cite.innerHTML = links
                  .map(l => `<a href="${l.url}" target="_blank" rel="noopener">${l.title || l.url}</a>`)
                  .join(' &middot; ');
                bot.appendChild(cite);
              }
            } catch { /* ignore */ }
            continue;
          }

          if (data) {
            const clean = data.replace(/\[\d+\]/g, '').replace(/\s*Sources?:.*$/i, '');
            bot.innerHTML += clean.replace(/\n/g, '<br/>');
            const log = document.getElementById('log');
            log.scrollTop = log.scrollHeight;
          }
        }
      }
    } catch (e) {
      hideTyping();
      addBubble('⚠️ Error: ' + e.message, 'bot');
    }
  }

  // ✅ Attach listeners AFTER askNow is defined
  document.addEventListener('DOMContentLoaded', () => {
    const askBtn = document.getElementById('ask');
    const qEl    = document.getElementById('q');

    if (askBtn) {
      if (askBtn._wired) askBtn.removeEventListener('click', askBtn._wired);
      askBtn._wired = (e) => { e.preventDefault(); askNow(); };
      askBtn.addEventListener('click', askBtn._wired);
    }

    if (qEl) {
      if (qEl._wired) qEl.removeEventListener('keydown', qEl._wired);
      qEl._wired = (e) => { if (e.key === 'Enter') { e.preventDefault(); askNow(); } };
      qEl.addEventListener('keydown', qEl._wired);
    }

    console.log('Ask wiring attached ✅');
  });
</script>
</body>
</html>

